<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Admin Panel - Permanent</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
            overflow: hidden;
            background-color: #000;
        }
        body { font-family: 'Inter', sans-serif; color: #e0e0e0; }
        #app-container {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .main-bg { background: radial-gradient(ellipse at center, #1a1a1a 0%, #000000 100%); }
        .cinzel-font { font-family: 'Cinzel', serif; }
        .premium-input { background-color: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
        .premium-input:focus { outline: none; border-color: rgba(220, 180, 100, 0.7); box-shadow: 0 0 15px rgba(220, 180, 100, 0.3); }
        .premium-button { background: linear-gradient(45deg, #3a3a3a, #1a1a1a); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); transition: all 0.3s ease; }
        .premium-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(220, 180, 100, 0.2); border-color: rgba(220, 180, 100, 0.5); }
        .premium-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .danger-button { background: linear-gradient(45deg, #8c2b2b, #5a1a1a); }
        .danger-button:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(220, 100, 100, 0.2); }
        .card-container { background-color: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
        .fade-out { transition: opacity 0.5s ease, transform 0.5s ease; opacity: 0; transform: scale(0.95); }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <div id="app-container" class="main-bg w-full">
        <div class="w-full max-w-7xl mx-auto p-4 md:p-8">
            <header class="sticky top-0 z-10 pt-safe-top bg-black/50 backdrop-blur-sm -mx-4 -mt-4 px-4 py-4 mb-4 md:-mx-8 md:-mt-8 md:px-8 md:py-6 md:mb-8">
                <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
                    <div class="text-center sm:text-left">
                        <h1 class="cinzel-font text-3xl md:text-4xl font-bold text-white tracking-wider">Admin Panel</h1>
                        <p class="text-gray-400">Permanent QR Generator Management</p>
                    </div>
                    <button id="globalRefreshBtn" class="premium-button text-white font-semibold px-4 py-3 rounded-lg flex items-center justify-center gap-2 mt-4 sm:mt-0" title="Refresh All Data">
                        <img id="globalRefreshIcon" src="https://img.icons8.com/ios-glyphs/30/ffffff/refresh--v1.png" alt="Refresh" class="w-5 h-5"/>
                        <span>Refresh</span>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 flex flex-col gap-8">
                    
                    <div class="card-container rounded-xl p-6">
                        <h2 class="cinzel-font text-2xl font-bold text-white mb-4">Generate Licenses</h2>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="number" id="licenseCount" placeholder="Amount" class="premium-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500" min="1" value="1">
                            <button id="generateLicensesBtn" class="premium-button text-white font-semibold px-6 py-3 rounded-lg whitespace-nowrap">Generate</button>
                        </div>
                        <p id="generateMessage" class="mt-2 h-4 text-sm"></p>
                    </div>

                    <div class="card-container rounded-xl p-6">
                        <h2 class="cinzel-font text-2xl font-bold text-white mb-4">Recently Generated</h2>
                        <div id="unactivatedLicensesList" class="max-h-96 overflow-y-auto pr-2">
                            <p id="loadingUnactivated" class="text-center text-gray-400">Loading...</p>
                        </div>
                    </div>

                    <!-- PERUBAHAN: Card untuk URL Management dipindahkan ke bawah -->
                    <div class="card-container rounded-xl p-6">
                        <h2 class="cinzel-font text-2xl font-bold text-white mb-4">App Configuration</h2>
                        <label for="currentUrlInput" class="text-sm text-gray-400 mb-2 block">Current URL</label>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <input type="url" id="currentUrlInput" placeholder="https://your-url.com" class="premium-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500">
                            <button id="saveUrlBtn" class="premium-button text-white font-semibold px-6 py-3 rounded-lg whitespace-nowrap">Save</button>
                        </div>
                        <p id="urlMessage" class="mt-2 h-4 text-sm"></p>
                    </div>
                </div>

                <div class="lg:col-span-2 card-container rounded-xl p-6">
                    <h2 class="cinzel-font text-2xl font-bold text-white mb-4">Active Users</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="searchEmail" placeholder="Search by email..." class="premium-input w-full px-4 py-3 rounded-lg text-white placeholder-gray-500">
                    </div>
                    <div id="activeUsersList" class="max-h-[34rem] overflow-y-auto pr-2">
                        <p id="loadingUsers" class="text-center text-gray-400">Loading users...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi -->
    <div id="confirmationModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden z-50 p-4">
        <div class="card-container rounded-xl p-8 max-w-sm w-full text-center">
            <h3 id="modalTitle" class="cinzel-font text-xl font-bold text-white mb-2">Confirm Action</h3>
            <p id="modalText" class="text-gray-300 mb-6"></p>
            <div class="flex gap-4">
                <button id="cancelBtn" class="premium-button text-white font-semibold py-2 rounded-lg flex-1">Cancel</button>
                <button id="confirmActionBtn" class="danger-button text-white font-semibold py-2 rounded-lg flex-1">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, deleteDoc, onSnapshot, writeBatch, serverTimestamp, getDocs, query, orderBy, limit, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAjs_-oH_kma3lHU4BCyStN8W0606MYLus",
        authDomain: "permanentmagicapp.firebaseapp.com",
        databaseURL: "https://permanentmagicapp-default-rtdb.firebaseio.com",
        projectId: "permanentmagicapp",
        storageBucket: "permanentmagicapp.firebasestorage.app",
        messagingSenderId: "695981452362",
        appId: "1:695981452362:web:a0155863e767fa63424ab3"
    };

    let auth, firestore;
    let allUsers = [];
    let isAuthReady = false;
    let currentAction = null, currentPayload = null;

    // DOM Elements
    const generateLicensesBtn = document.getElementById('generateLicensesBtn');
    const licenseCountInput = document.getElementById('licenseCount');
    const generateMessage = document.getElementById('generateMessage');
    const activeUsersList = document.getElementById('activeUsersList');
    const loadingUsers = document.getElementById('loadingUsers');
    const searchEmailInput = document.getElementById('searchEmail');
    const confirmationModal = document.getElementById('confirmationModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalText = document.getElementById('modalText');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmActionBtn = document.getElementById('confirmActionBtn');
    const globalRefreshBtn = document.getElementById('globalRefreshBtn');
    const globalRefreshIcon = document.getElementById('globalRefreshIcon');
    const unactivatedLicensesList = document.getElementById('unactivatedLicensesList');
    const loadingUnactivated = document.getElementById('loadingUnactivated');
    const currentUrlInput = document.getElementById('currentUrlInput');
    const saveUrlBtn = document.getElementById('saveUrlBtn');
    const urlMessage = document.getElementById('urlMessage');

    async function initialize() {
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            firestore = getFirestore(app);
            await signInAnonymously(auth);

            auth.onAuthStateChanged(user => {
                if (user) {
                    isAuthReady = true;
                    fetchCurrentUrl();
                    listenForActiveUsers();
                    fetchUnactivatedLicenses();
                }
            });
        } catch (error) {
            console.error("Initialization Failed:", error);
        }
    }

    function showTemporaryMessage(element, message, isError = false, duration = 3000) {
        element.textContent = message;
        element.className = `mt-2 h-4 text-sm ${isError ? 'text-red-400' : 'text-green-400'}`;
        setTimeout(() => element.textContent = "", duration);
    }

    async function fetchCurrentUrl() {
        try {
            const configRef = doc(firestore, "config", "settings");
            const docSnap = await getDoc(configRef);
            if (docSnap.exists()) {
                currentUrlInput.value = docSnap.data().currentURL || '';
            } else {
                console.log("No config document found!");
            }
        } catch (error)
        {
            console.error("Error fetching URL:", error);
            showTemporaryMessage(urlMessage, "Failed to load URL.", true);
        }
    }

    async function handleSaveUrl() {
        const newUrl = currentUrlInput.value.trim();
        if (!newUrl) {
            showTemporaryMessage(urlMessage, "URL cannot be empty.", true);
            return;
        }
        saveUrlBtn.disabled = true;
        saveUrlBtn.textContent = "Saving...";
        try {
            const configRef = doc(firestore, "config", "settings");
            await setDoc(configRef, { currentURL: newUrl }, { merge: true });
            showTemporaryMessage(urlMessage, "URL saved successfully!");
        } catch (error) {
            console.error("Error saving URL:", error);
            showTemporaryMessage(urlMessage, "An error occurred.", true);
        } finally {
            saveUrlBtn.disabled = false;
            saveUrlBtn.textContent = "Save";
        }
    }

    function createLicenseCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < 12; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
            if ((i + 1) % 4 === 0 && i < 11) result += '-';
        }
        return result;
    }

    async function handleGenerateLicenses() {
        const count = parseInt(licenseCountInput.value, 10);
        if (isNaN(count) || count < 1) {
            showTemporaryMessage(generateMessage, "Please enter a valid amount.", true);
            return;
        }
        generateLicensesBtn.disabled = true;
        generateLicensesBtn.textContent = "Generating...";
        try {
            const batch = writeBatch(firestore);
            for (let i = 0; i < count; i++) {
                const newCode = createLicenseCode();
                const licenseRef = doc(firestore, "availableLicenses", newCode);
                batch.set(licenseRef, { createdAt: serverTimestamp() });
            }
            await batch.commit();
            showTemporaryMessage(generateMessage, `${count} licenses generated successfully!`);
            fetchUnactivatedLicenses();
        } catch (error) {
            console.error("Error generating licenses:", error);
            showTemporaryMessage(generateMessage, "An error occurred.", true);
        } finally {
            generateLicensesBtn.disabled = false;
            generateLicensesBtn.textContent = "Generate";
        }
    }
    
    async function fetchUnactivatedLicenses() {
        loadingUnactivated.textContent = "Loading...";
        try {
            const licensesCol = collection(firestore, 'availableLicenses');
            const q = query(licensesCol, orderBy("createdAt", "desc"), limit(100));
            const querySnapshot = await getDocs(q);
            
            const licenses = querySnapshot.docs.map(doc => ({
                code: doc.id,
                ...doc.data()
            }));

            displayUnactivatedLicenses(licenses);
        } catch (error) {
            console.error("Failed to fetch licenses:", error);
            loadingUnactivated.textContent = "Failed to load.";
        }
    }

    function displayUnactivatedLicenses(licenses) {
        unactivatedLicensesList.innerHTML = '';
        if (licenses.length === 0) {
            unactivatedLicensesList.innerHTML = '<p class="text-center text-gray-400">No available licenses.</p>';
            return;
        }
        licenses.forEach(({ code }) => {
            const licenseDiv = document.createElement('div');
            licenseDiv.className = 'license-item p-3 bg-gray-900/50 rounded-lg mb-2';
            licenseDiv.innerHTML = `
                <p class="text-white font-mono text-center text-lg break-all mb-3">${code}</p>
                <div class="flex gap-2 justify-center">
                    <button data-code="${code}" class="copy-btn premium-button text-white font-semibold px-3 py-1 text-sm rounded-lg flex-1">Copy</button>
                    <button data-code="${code}" class="share-btn premium-button text-white font-semibold px-3 py-1 text-sm rounded-lg flex-1">Share</button>
                    <button data-code="${code}" class="delete-btn danger-button text-white font-semibold px-3 py-1 text-sm rounded-lg">Delete</button>
                </div>
            `;
            unactivatedLicensesList.appendChild(licenseDiv);
        });
    }

    function listenForActiveUsers() {
        const activeLicensesCol = collection(firestore, "activatedLicenses");
        onSnapshot(activeLicensesCol, (snapshot) => {
            allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allUsers.sort((a, b) => (b.activatedAt?.toDate() || 0) - (a.activatedAt?.toDate() || 0));
            displayUsers(allUsers);
        }, (error) => {
            console.error("Failed to listen for changes:", error);
            loadingUsers.textContent = "Failed to load user data.";
        });
    }

    function displayUsers(users) {
        activeUsersList.innerHTML = '';
        const searchTerm = searchEmailInput.value.toLowerCase();
        const filtered = searchTerm ? users.filter(u => u.email.toLowerCase().includes(searchTerm)) : users;
        if (users.length === 0) {
            activeUsersList.innerHTML = '<p class="text-center text-gray-400">No active users yet.</p>';
            return;
        }
        if (filtered.length === 0) {
            activeUsersList.innerHTML = '<p class="text-center text-gray-400">No matching users found.</p>';
            return;
        }
        filtered.forEach(user => {
            const userElement = document.createElement('div');
            userElement.className = 'user-item p-3 border-b border-gray-700 flex justify-between items-center';
            const activationDate = user.activatedAt ? user.activatedAt.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            userElement.innerHTML = `<div><p class="text-white font-semibold">${user.email}</p><p class="text-sm text-gray-400 font-mono">${user.licenseCode}</p><p class="text-xs text-gray-500">Activated: ${activationDate}</p></div><button data-id="${user.id}" class="terminate-btn danger-button text-white font-semibold px-3 py-1 text-sm rounded-lg">Terminate</button>`;
            activeUsersList.appendChild(userElement);
        });
    }
    
    async function deleteUnactivatedLicense(licenseCode, element) {
        try {
            element.classList.add('fade-out');
            await new Promise(resolve => setTimeout(resolve, 500));
            const licenseRef = doc(firestore, 'availableLicenses', licenseCode);
            await deleteDoc(licenseRef);
            element.remove();
        } catch (error) {
            console.error("Failed to delete license:", error);
            element.classList.remove('fade-out');
        }
    }
    
    async function terminateUser(docId, element) {
        try {
            element.classList.add('fade-out');
            await new Promise(resolve => setTimeout(resolve, 500));
            const docRef = doc(firestore, "activatedLicenses", docId);
            await deleteDoc(docRef);
        } catch (error) {
            console.error(`Failed to terminate user:`, error);
            element.classList.remove('fade-out');
        }
    }

    async function handleGlobalRefresh() {
        globalRefreshIcon.classList.add('spin');
        globalRefreshBtn.disabled = true;
        searchEmailInput.value = '';
        displayUsers(allUsers);
        await fetchCurrentUrl();
        await fetchUnactivatedLicenses();
        setTimeout(() => {
            globalRefreshIcon.classList.remove('spin');
            globalRefreshBtn.disabled = false;
        }, 500);
    }

    // === Event Listeners ===
    initialize();
    saveUrlBtn.addEventListener('click', handleSaveUrl);
    generateLicensesBtn.addEventListener('click', handleGenerateLicenses);
    searchEmailInput.addEventListener('input', () => displayUsers(allUsers));
    globalRefreshBtn.addEventListener('click', handleGlobalRefresh);

    unactivatedLicensesList.addEventListener('click', (e) => {
        const target = e.target;
        const element = target.closest('.license-item');
        if (!element) return;
        
        const code = target.dataset.code;
        
        const messageToShare = `Thank you so much for purchasing PERMANENT.
Your support truly means the world to me as an independent creator in magic.

Here’s your personal license code (one-time use only) :

${code}

I hope you enjoy using it, and I’d love to hear your thoughts or see how you apply it in your work.

Warm regards,
Heri Sanjaya`;

        if (target.classList.contains('copy-btn')) {
            navigator.clipboard.writeText(messageToShare).then(() => {
                target.textContent = 'Copied!';
                setTimeout(() => target.textContent = 'Copy', 2000);
            });
        } else if (target.classList.contains('share-btn')) {
             if (navigator.share) {
                navigator.share({
                    title: 'Permanent License Code',
                    text: messageToShare,
                }).catch(console.error);
            } else {
                alert('Share feature is not supported in this browser. Please copy the text manually.');
            }
        } else if (target.classList.contains('delete-btn')) {
            currentAction = 'deleteUnactivatedLicense';
            currentPayload = { licenseCode: code, element };
            modalTitle.textContent = "Confirm Deletion";
            modalText.textContent = `Are you sure you want to delete license ${code}?`;
            confirmationModal.classList.remove('hidden');
        }
    });

    activeUsersList.addEventListener('click', (e) => {
        if (e.target.classList.contains('terminate-btn')) {
            const docId = e.target.dataset.id;
            const element = e.target.closest('.user-item');
            currentAction = 'terminateUser';
            currentPayload = { docId, element };
            modalTitle.textContent = "Confirm Termination";
            modalText.textContent = "Are you sure you want to terminate this user's license?";
            confirmationModal.classList.remove('hidden');
        }
    });

    confirmActionBtn.onclick = async () => {
        if (!currentAction || !currentPayload) return;
        confirmActionBtn.disabled = true;
        if (currentAction === 'terminateUser') {
            await terminateUser(currentPayload.docId, currentPayload.element);
        } else if (currentAction === 'deleteUnactivatedLicense') {
            await deleteUnactivatedLicense(currentPayload.licenseCode, currentPayload.element);
        }
        confirmationModal.classList.add('hidden');
        confirmActionBtn.disabled = false;
        currentAction = null;
        currentPayload = null;
    };

    cancelBtn.addEventListener('click', () => {
        confirmationModal.classList.add('hidden');
    });

</script>

</body>
</html>