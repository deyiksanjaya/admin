<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>ShowTime Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- PWA Manifest Link -->
  <link rel="manifest" href="/manifest.json">

  <!-- Apple PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ShowTime Admin">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <!-- You might want to add more specific sizes for apple-touch-icon if needed, e.g.,
       <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
       <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-touch-icon-152x152.png">
       For simplicity, we'll use one general apple-touch-icon. -->

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0a0a0a;
      color: #e5e5e5;
    }
    .card {
      background-color: #1c1c1e;
      border: 1px solid #2d2d2f;
      border-radius: 16px;
    }
    .card-header {
      background-color: #2c2c2e;
      padding: 16px 24px;
      border-bottom: 1px solid #2d2d2f;
    }
    .card-title {
      color: #ffffff;
      font-weight: 600;
    }
    .card-subtitle {
      color: #FFA00A;
      font-size: 0.875rem;
      font-weight: 500;
    }
    .form-input {
        background-color: #2c2c2e;
        border: 1px solid #3d3d3f;
        color: #e5e5e5;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        width: 100%;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-input:focus {
        outline: none;
        border-color: #FFA00A;
        box-shadow: 0 0 0 2px rgba(255, 160, 10, 0.3);
    }
    .btn {
        background-color: #FFA00A;
        color: #1c1c1e;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        text-align: center;
        transition: background-color 0.2s;
        cursor: pointer;
        width: 100%;
    }
    .btn:hover {
        background-color: #ffb03a;
    }
    .license-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #2d2d2f;
        transition: background-color 0.2s;
    }
    .license-item:last-child {
        border-bottom: none;
    }
    .license-name {
        font-size: 1.125rem; /* text-lg */
        font-weight: 600;
        color: #ffffff;
    }
    .license-key {
        font-family: monospace;
        font-size: 0.8rem;
        color: #9ca3af; /* gray-400 */
        word-break: break-all;
    }
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }
    .action-btn-inline {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background-color: #333;
        color: #ccc;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 0.3rem 0.6rem;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
    }
    .action-btn-inline:hover {
        background-color: #444;
        color: #fff;
    }
    .action-btn-inline.delete:hover {
        background-color: #991b1b; /* red-800 */
        color: #fff;
    }
    .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translate(-50%, 150%);
        background-color: #2c2c2e;
        color: #fff;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        transition: transform 0.3s ease-in-out;
        z-index: 100;
    }
    .toast.show {
        transform: translate(-50%, 0);
    }
    .modal-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }
    .status-badge {
        display: inline-block;
        padding: 0.2rem 0.6rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 9999px;
    }
    .status-badge.activated {
        background-color: #166534; /* green-800 */
        color: #dcfce7; /* green-100 */
    }
    .status-badge.available {
        background-color: #1d4ed8; /* blue-700 */
        color: #dbeafe; /* blue-100 */
    }
  </style>
</head>
<body class="antialiased">

  <div class="container mx-auto p-4 md:p-8 max-w-2xl">

    <header class="text-center mb-8">
      <h1 class="text-4xl md:text-5xl font-bold text-white mb-1">ShowTime</h1>
      <p class="text-lg text-gray-400">Admin Panel</p>
    </header>

    <div class="card">
      <div id="login">
        <div class="card-header">
          <p class="card-subtitle">Authentication Required</p>
          <h2 class="card-title text-xl">Enter Admin Password</h2>
        </div>
        <div class="p-6 md:p-8 space-y-4">
          <input type="password" id="passwordInput" class="form-input" placeholder="••••••••">
          <button onclick="checkPassword()" class="btn">Login</button>
          <p id="loginError" class="text-red-500 text-sm text-center h-5"></p>
        </div>
      </div>

      <div id="panel" class="hidden">
        <div class="card-header flex justify-between items-center">
            <div>
                <p class="card-subtitle">Control Center</p>
                <h2 class="card-title text-xl">License Management</h2>
            </div>
            <div id="licenseCount" class="text-right"></div>
        </div>
        <div class="p-6 md:p-8 space-y-6">
            <div class="space-y-3 p-4 bg-black/20 rounded-lg">
                <label for="customerNameInput" class="block text-sm font-medium text-gray-300">Generate License</label>
                <input type="text" id="customerNameInput" class="form-input" placeholder="Enter customer name...">
                <button onclick="generateAndAssignKey()" class="btn flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                    Generate & Assign Key
                </button>
            </div>
            
            <hr class="border-gray-700">

            <div class="relative">
                <input type="text" id="searchInput" class="form-input pl-10" placeholder="Search by key or customer name...">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>

            <div id="licenseListContainer">
                <div id="licenseList" class="border border-gray-700 rounded-lg max-h-[60vh] overflow-y-auto">
                    <div class="p-8 text-center text-gray-500">Loading licenses...</div>
                </div>
            </div>

            <button onclick="logout()" class="btn bg-gray-700 hover:bg-gray-600 text-white flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="17 16 22 12 17 8"></polyline><line x1="22" y1="12" x2="10" y2="12"></line></svg>
                Logout
            </button>
        </div>
      </div>
    </div>
    
    <footer class="text-center mt-8 mb-6">
        <p class="text-gray-500 text-sm">Handle with care.</p>
    </footer>

  </div>
  
  <div id="toast" class="toast"></div>
  
  <div id="confirmModal" class="modal-overlay hidden">
      <div class="card max-w-sm w-full mx-4">
          <div class="p-6">
              <h3 id="confirmTitle" class="text-lg font-bold text-white">Konfirmasi Tindakan</h3>
              <p id="confirmMessage" class="text-gray-300 mt-2">Apakah Anda yakin ingin melanjutkan?</p>
              <div class="flex justify-end gap-4 mt-6">
                  <button id="cancelBtn" class="px-4 py-2 rounded-lg text-white hover:bg-gray-700">Batal</button>
                  <button id="confirmBtn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Hapus</button>
              </div>
          </div>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBm2cw6dircA3IMc3yCEeCgVa5--5W6DUw",
      authDomain: "showtime-f086c.firebaseapp.com",
      databaseURL: "https://showtime-f086c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "showtime-f086c",
      storageBucket: "showtime-f086c.appspot.com",
      messagingSenderId: "31064800242",
      appId: "1:31064800242:web:8b290d03eda9bf7d95896b"
    };

    // --- App Initialization ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let ADMIN_PASSWORD = "";
    let allLicenses = {}; // Cache for all licenses for searching

    // --- Authentication ---
    const passwordRef = ref(db, "data/admin/password");
    get(passwordRef).then((snapshot) => {
      if (snapshot.exists()) {
        ADMIN_PASSWORD = snapshot.val();
        // Check for stored login state after password is loaded
        checkStoredLogin();
      } else {
        document.getElementById("loginError").textContent = "⚠️ Admin password not set in Firebase.";
      }
    }).catch(error => {
        console.error("Error fetching password:", error);
        document.getElementById("loginError").textContent = "⚠️ Could not connect to database.";
    });

    function checkStoredLogin() {
        const isLoggedIn = localStorage.getItem('showtime_admin_loggedIn');
        if (isLoggedIn === 'true') {
            document.getElementById("login").classList.add("hidden");
            document.getElementById("panel").classList.remove("hidden");
            initAdminPanel();
        }
    }

    window.checkPassword = () => {
      const passwordInput = document.getElementById("passwordInput");
      if (passwordInput.value === ADMIN_PASSWORD) {
        localStorage.setItem('showtime_admin_loggedIn', 'true'); // Store login state
        document.getElementById("login").classList.add("hidden");
        document.getElementById("panel").classList.remove("hidden");
        initAdminPanel();
      } else {
        document.getElementById("loginError").textContent = "❌ Incorrect password. Please try again.";
        passwordInput.value = "";
      }
    };
    
    window.logout = () => {
        localStorage.removeItem('showtime_admin_loggedIn'); // Clear login state
        document.getElementById("panel").classList.add("hidden");
        document.getElementById("login").classList.remove("hidden");
        document.getElementById("passwordInput").value = ""; // Clear password input
        document.getElementById("loginError").textContent = ""; // Clear any error messages
        showToast("Logged out successfully.");
    };

    document.getElementById("passwordInput").addEventListener("keyup", (event) => {
        if (event.key === "Enter") {
            event.preventDefault();
            checkPassword();
        }
    });

    // --- Core Functions ---
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    window.generateAndAssignKey = async () => {
      const customerNameInput = document.getElementById('customerNameInput');
      const customerName = customerNameInput.value.trim();

      if (!customerName) {
        showToast('⚠️ Please enter a customer name.');
        customerNameInput.focus();
        return;
      }

      const newKey = generateUUID().toUpperCase();
      const licenseRef = ref(db, "data/licenses/" + newKey);
      const newLicenseData = {
          createdAt: new Date().toISOString(),
          note: customerName, // 'note' field now stores the customer name
          isActivated: false,
          activatedAt: null,
          activatedBy: null
      };
      try {
        await set(licenseRef, newLicenseData);
        showToast(`✅ Key for ${customerName} created!`);
        customerNameInput.value = ''; // Clear input after success
      } catch (error) {
        console.error("Error saving key:", error);
        showToast('❌ Error: Could not save key to database.');
      }
    };
    
    function initAdminPanel() {
        listenForLicenses();
        setupEventListeners();
    }

    function listenForLicenses() {
        const licensesRef = ref(db, 'data/licenses/');
        onValue(licensesRef, (snapshot) => {
            if (snapshot.exists()) {
                allLicenses = snapshot.val();
                renderLicenses(allLicenses);
            } else {
                allLicenses = {};
                renderLicenses({});
            }
        });
    }
    
    function renderLicenses(licenses) {
        const licenseListDiv = document.getElementById('licenseList');
        const licenseCountDiv = document.getElementById('licenseCount');
        licenseListDiv.innerHTML = '';
        
        const keys = Object.keys(licenses);

        const total = keys.length;
        const activated = keys.filter(k => licenses[k].isActivated).length;
        licenseCountDiv.innerHTML = `
            <p class="text-white font-bold text-lg">${total} Total</p>
            <p class="text-sm text-gray-400">${activated} Activated</p>
        `;

        if (keys.length === 0) {
            licenseListDiv.innerHTML = '<div class="p-8 text-center text-gray-500">No licenses found. Generate one to get started.</div>';
            return;
        }

        keys.sort((a, b) => new Date(licenses[b].createdAt) - new Date(licenses[a].createdAt));

        keys.forEach(key => {
            const licenseData = licenses[key];
            const item = createLicenseItem(key, licenseData);
            licenseListDiv.appendChild(item);
        });
    }

    function createLicenseItem(key, data) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'license-item';
        itemDiv.id = `license-${key}`;

        const createdAt = new Date(data.createdAt).toLocaleDateString('id-ID', {
            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        const statusBadge = data.isActivated
            ? `<span class="status-badge activated">Activated</span>`
            : `<span class="status-badge available">Available</span>`;

        itemDiv.innerHTML = `
            <div class="flex justify-between items-start gap-4">
                <div>
                    <h3 class="license-name">${data.note || 'No Name'}</h3>
                    <span class="license-key">${key}</span>
                    <div class="text-xs text-gray-500 mt-1">Created: ${createdAt}</div>
                </div>
                <div class="text-right flex-shrink-0">
                    ${statusBadge}
                </div>
            </div>
            <div class="action-buttons mt-4">
                <button class="action-btn-inline" data-action="copy-key" data-key="${key}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    <span>Copy Key</span>
                </button>
                <button class="action-btn-inline" data-action="copy-msg" data-key="${key}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path></svg>
                    <span>Copy Message</span>
                </button>
                <button class="action-btn-inline" data-action="share" data-key="${key}">
                     <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                    <span>Share</span>
                </button>
                <button class="action-btn-inline delete" data-action="delete" data-key="${key}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    <span>Delete</span>
                </button>
            </div>
        `;
        return itemDiv;
    }
    
    function setupEventListeners() {
        const licenseListDiv = document.getElementById('licenseList');
        
        document.getElementById('customerNameInput').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                generateAndAssignKey();
            }
        });
        
        licenseListDiv.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const key = button.dataset.key;
            const action = button.dataset.action;

            if (key && action) {
                if (action === 'copy-key') copyToClipboard(key, 'Key copied!');
                if (action === 'copy-msg') copyLicenseMessage(key);
                if (action === 'share') shareLicense(key);
                if (action === 'delete') confirmDelete(key);
            }
        });

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredLicenses = {};
            for (const key in allLicenses) {
                const license = allLicenses[key];
                const note = (license.note || '').toLowerCase(); // 'note' is the customer name
                if (key.toLowerCase().includes(searchTerm) || note.includes(searchTerm)) {
                    filteredLicenses[key] = license;
                }
            }
            renderLicenses(filteredLicenses);
        });
    }

    function copyToClipboard(text, successMessage) {
        // Use document.execCommand('copy') for better iframe compatibility
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast(successMessage);
            } else {
                throw new Error('Copy command failed');
            }
        } catch (err) {
            console.error('Failed to copy: ', err);
            showToast('Error: Could not copy. Please copy manually.');
        } finally {
            document.body.removeChild(textarea);
        }
    }
    
    // --- UPDATED FUNCTION ---
    function getLicenseMessage(key) {
        const licenseData = allLicenses[key];
        const customerName = licenseData?.note || 'there';
        
        const greeting = `Hi, ${customerName}! Thank you for purchasing ShowTime! Your support means a great deal to me as an independent developer, helping me to create new things in the future.`;

        const instructions = `Here are your next steps to activate the app:

1. Please open the activation page on your phone:
   https://showtime-rose.vercel.app/activate.html

2. You will be asked for a license key. Please use the code below:`;

        // The final message combines everything
        return `${greeting}\n\n${instructions}\n\n${key}`;
    }

    function copyLicenseMessage(key) {
        const textToCopy = getLicenseMessage(key);
        copyToClipboard(textToCopy, 'Activation message copied!');
    }

    async function shareLicense(key) {
        const textToShare = getLicenseMessage(key);
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'ShowTime License Key',
                    text: textToShare,
                });
            } catch (err) {
                console.error('Error sharing:', err);
                showToast('Share failed or cancelled.');
            }
        } else {
            showToast('Web Share API is not supported. Copying message...');
            copyLicenseMessage(key);
        }
    }

    function confirmDelete(key) {
        const modal = document.getElementById('confirmModal');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const message = document.getElementById('confirmMessage');
        const customerName = allLicenses[key]?.note || `key ${key.substring(0,8)}...`;

        message.textContent = `Are you sure you want to delete the license for ${customerName}? This action cannot be undone.`;
        modal.classList.remove('hidden');

        const confirmHandler = () => {
            deleteLicense(key);
            cleanup();
        };

        const cancelHandler = () => cleanup();

        const cleanup = () => {
            modal.classList.add('hidden');
            confirmBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };
        
        confirmBtn.addEventListener('click', confirmHandler, { once: true });
        cancelBtn.addEventListener('click', cancelHandler, { once: true });
    }

    function deleteLicense(key) {
        const licenseRef = ref(db, `data/licenses/${key}`);
        remove(licenseRef).then(() => {
            showToast(`License has been deleted.`);
        }).catch(err => {
            console.error('Error deleting key:', err);
            showToast('Error: Could not delete key.');
        });
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          })
          .catch(err => {
            console.error('ServiceWorker registration failed: ', err);
          });
      });
    }

  </script>
</body>
</html>
